---
title: "PCA plots for identification of outliers to prune from the dataset"
output: html_document
date: "2024-03-01"
---

# Setting up the Working Directory of the .rmd script
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Defining the relative path in the repository
repository_path <- "/Computational-modelling-of-genomic-inbreeding-and-roh-islands-in-extremely-small-populations"

# Set the path to your GitHub folder
YOUR_GITHUB_ROOT_DIRECTORY <- "C:/Users/jonat/GitHub"

# Set the root directory for notebook chunks
knitr::opts_knit$set(root.dir = file.path(YOUR_GITHUB_ROOT_DIRECTORY, repository_path))


# # Verify the current working directory
# getwd()

```

# ROH-Hotspot extraction
Plots are created both for the preprocessed and the raw datasets

```{r ROH-Hotspot extraction}
# Load the MASS package for fitdistr function
library(MASS)
library(ggplot2)

# Read the data
#data <- read.table("sorted_population_coverage.bed", header = FALSE)
data <- read.table("38_chr_sorted_population_coverage.bed", header = FALSE)

# Rename the columns
colnames(data) <- c("CHR", "POS1", "POS2", "COUNT", "FREQUENCY")


# Frequency Data is chosen
values <- data$FREQUENCY

# Sort the values in descending order to find the top 1%
sorted_values <- sort(values, decreasing = TRUE)

# Calculate the threshold for the top 1%
threshold_index <- ceiling(0.01 * length(sorted_values))
threshold <- sorted_values[threshold_index]

# Identify genomic windows with ROH frequency above the threshold
top_1_percent_ROH <- data[data$FREQUENCY > threshold, ]

# Print the top 1% of ROH regions
print(top_1_percent_ROH)
```
# Generating merged together ROH-hotspot windows
```{r}
# Initialize an empty dataframe to store merged rows
merged_top_1_percent_ROH <- data.frame(CHR = character(), POS1 = integer(), POS2 = integer(), COUNT = integer(), FREQUENCY = numeric())
# Initialize a variable to store the previous row
prev_row <- NULL

# Iterate over each row in the top 1% ROH data
for (i in 1:nrow(top_1_percent_ROH)) {
  # Get the current row
  current_row <- top_1_percent_ROH[i, ]
  
  # Check if it's the first row or if conditions for merging are met
  if (!is.null(prev_row) && current_row$CHR == prev_row$CHR && current_row$COUNT == prev_row$COUNT && as.integer(current_row$POS1) == as.integer(prev_row$POS2) + 1) {
    # Merge the current row with the previous one
    prev_row$POS2 <- current_row$POS2
  } else {
    # If conditions for merging are not met, add the previous row to the merged dataframe
    if (!is.null(prev_row)) {
      merged_top_1_percent_ROH <- rbind(merged_top_1_percent_ROH, prev_row)
    }
    # Update the previous row to the current row
    prev_row <- current_row
  }
}

# Add the last row to the merged dataframe
if (!is.null(prev_row)) {
  merged_top_1_percent_ROH <- rbind(merged_top_1_percent_ROH, prev_row)
}

# Calculate the length in kilobases (kb)
merged_top_1_percent_ROH$Length_kb <- (merged_top_1_percent_ROH$POS2 - merged_top_1_percent_ROH$POS1 + 1) / 1000


# Print the merged top 1% ROH data
print(merged_top_1_percent_ROH)
```


# ROH Hotspot plots

```{r}
# Create scatter plots for each chromosome
for (CHR in unique(data$CHR)) {
  # Subset data for the current chromosome
  chr_data <- data[data$CHR == CHR, ]
  chr_merged_data <- merged_top_1_percent_ROH[merged_top_1_percent_ROH$CHR == CHR, ]
  
  # Create scatter plot
  p <- ggplot() +
    geom_point(data = chr_data, aes(x = POS1, y = FREQUENCY, color = "ROH-segments"), alpha = 0.5) +
    geom_point(data = chr_merged_data, aes(x = POS1, y = FREQUENCY, color = "ROH hotspots"), alpha = 0.5) +
    geom_hline(aes(yintercept = threshold, color = "ROH hotspot threshold"), linetype = "dashed") +
    labs(title = paste("Scatter Plot for Chromosome", CHR),
         x = "Position",
         y = "FREQUENCY",
         color = "Legend") +
    scale_color_manual(values = c("ROH-segments" = "gray", "ROH hotspots" = "blue", "ROH hotspot threshold" = "red"),
                       labels = c("ROH-segments" = "ROH-segments", "ROH hotspots" = "ROH hotspots", "ROH hotspot threshold" = "ROH hotspot threshold")) +
    theme_minimal()
  
  # Print the plot
  print(p)
}


```


```{r PCA_Plot}
# Data is in the fourth column
y <- qnorm(values,mean(values),sd(values))

plot(data,y)
```

# Exporting the ROH Hotspot files into .tsv files
```{r Export ROH-Hotspots,eval=TRUE}
# Define a function to split each window into two rows
split_window <- function(data) {
  # Create a new dataframe to store the split rows
  new_data <- data.frame(
    CHR = data$CHR,
    POS = c(data$POS1, data$POS2),
    COUNT = rep(data$COUNT, 2),
    FREQUENCY = rep(data$FREQUENCY, 2),
    Length_kb = rep(data$Length_kb, 2),
    Hotspot_interval = c(paste0("[", data$POS1, ",", data$POS2, "]"), paste0("[", data$POS1, ",", data$POS2, "]"))
  )
  return(new_data)
}

# Initialize an empty list to store the split dataframes
split_data <- list()

# Iterate over each chromosome
for (CHR in unique(merged_top_1_percent_ROH$CHR)) {
  # Subset data for the current chromosome
  chr_data <- merged_top_1_percent_ROH[merged_top_1_percent_ROH$CHR == CHR, ]
  
  # Split each window into two rows
  split_data[[CHR]] <- split_window(chr_data)
}

# Combine all split dataframes into one
split_data_combined <- do.call(rbind, split_data)

# Export the combined split dataframe to TSV files for each chromosome
for (CHR in unique(merged_top_1_percent_ROH$CHR)) {
  # Subset the split data for the current chromosome
  chr_split_data <- split_data_combined[split_data_combined$CHR == CHR, ]
  
  # Define the filename
  filename <- paste("CHR", CHR, "_ROH_hotspot_data_split.tsv", sep = "")
  
  # Write data to TSV file without quotes and with tab separation
  write.table(chr_split_data, file = filename, sep = "\t", row.names = FALSE, quote = FALSE)
}



```

# Exporting the relevant chromosome files into .tsv files
```{r}
# Define a function to split each window into two rows
split_window <- function(data) {
  # Create a new dataframe to store the split rows
  new_data <- data.frame(
    CHR = data$CHR,
    POS = c(data$POS1, data$POS2),
    COUNT = rep(data$COUNT, 2),
    FREQUENCY = rep(data$FREQUENCY, 2)
  )
  return(new_data)
}

# Initialize an empty list to store the split dataframes
split_data <- list()

# Iterate over each chromosome
for (CHR in unique(data$CHR)) {
  # Subset data for the current chromosome
  chr_data <- data[data$CHR == CHR, ]
  
  # Split each window into two rows
  split_data[[CHR]] <- split_window(chr_data)
}

# Combine all split dataframes into one
split_data_combined <- do.call(rbind, split_data)

# Export the combined split dataframe to TSV files for each chromosome
for (CHR in unique(data$CHR)) {
  # Subset the split data for the current chromosome
  chr_split_data <- split_data_combined[split_data_combined$CHR == CHR, ]
  
  # Define the filename
  filename <- paste("CHR", CHR, "_threshold_", threshold, "_ROH_data.tsv", sep = "")
  
  # Write data to TSV file without quotes and with tab separation
  write.table(chr_split_data, file = filename, sep = "\t", row.names = FALSE, quote = FALSE)
}


```