---
title: "Selective sweep test expected heterozygosity"
output: html_document
date: "2024-04-09"
editor_options: 
  markdown: 
    wrap: 72
---

# 0: Preparation

## Defining the input and output directories

```{r}
# Clean the working environment
rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)

# Set the path to your GitHub folder
YOUR_GITHUB_ROOT_DIRECTORY <- "C:/Users/jonat/GitHub"

# Defining the relative path in the repository
repository_path <- "Computational-modelling-of-genomic-inbreeding-and-roh-islands-in-extremely-small-populations"


####################################  
# Defining the input files
#################################### 



ROH_hotspot_allele_freq_dir <- file.path(YOUR_GITHUB_ROOT_DIRECTORY, repository_path,"results/ROH-Hotspots/empirical/german_shepherd/gosling_plots/hotspots_allele_freq")

neutral_model_allele_freq_dir <- file.path(YOUR_GITHUB_ROOT_DIRECTORY, repository_path,"results/PLINK/simulated/allele_freq")


####################################  
# Defining the working directory
#################################### 

output_dir_sweep_test <- file.path(YOUR_GITHUB_ROOT_DIRECTORY, repository_path,"results/Sweep_test/german_shepherd")


if (!dir.exists(output_dir_sweep_test)) {
  # Create the working directory if it doesn't exist
  dir.create(output_dir_sweep_test,recursive = TRUE)
}

# Set the working directory for notebook chunks
knitr::opts_knit$set(root.dir = output_dir_sweep_test)

```

## Loading libraries

```{r library()}
library(knitr)
```

# 1: Loading the frequency files

## 1.1: Empirical ROH-Hotspots - Loading the allele frequencies

```{r}
# Set the working directory to the directory with allele frequencies for the different ROH-hotspots
setwd(ROH_hotspot_allele_freq_dir)

# Get a list of all .bed files in the directory
bed_files <- list.files(pattern = "\\.bed$")

# Create an empty list to store information for the different ROH-hotspots in
empirical_hotspot_tables <- list()

# Loop through each .bed file (ROH-hotspot allele frequency window-file)
for (file in bed_files) {
  # Extract chromosome number and window number from file name
  chromosome <- sub(".*chr([0-9]+)_.*", "\\1", file)
  window <- sub(".*window_([0-9]+)_.*", "\\1", file)
  
  # Create table name
  table_name <- paste("Hotspot_chr", chromosome, "_window_", window, "_allele_freq", sep = "")
  
  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)
  
  # Remove "#" from the header and split it into column names
  column_names <- sub("#", "", header)
  column_names <- strsplit(column_names, "\t")[[1]]
  
  # Read the .bed file into a data frame, skipping commented lines
  bed_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  
  # Create a list with table name and corresponding data frame
  table_info <- list(name = table_name, data = bed_data)
  
  # Append the table info to the list
  empirical_hotspot_tables <- c(empirical_hotspot_tables, list(table_info))
}

# Print the list of empirical_hotspot_tables
#print(empirical_hotspot_tables)


```

## 1.2: Neutral model - Loading the allele frequencies

```{r}



# Set the working directory to the directory containing the frequency files for the simulated data
setwd(neutral_model_allele_freq_dir)

# Get a list of all the .tsv frequency files in the current directory 
# (these .tsv files are identical to the .frq files, but with a POS-column added, to associate the SNP-markers with a genomic position)
frq_files <- list.files(pattern = "\\.tsv$")

# Initialize an empty list to store neutral model tables
neutral_model_tables <- list()

# Loop through each .frq file
for (file in frq_files) {
 
  # Extract the table name from the file name
  table_name <- gsub(".frq$", "", file)
  
  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)
  
  # Remove "#" from the header and split it into column names
  column_names <- sub("#", "", header)
  column_names <- strsplit(column_names, "\t")[[1]]
  
  # Read the .tsv frequency file into a data frame
  #frq_data <- read.table(file, header = TRUE)
  frq_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  
  # Create a list with table name and corresponding data frame
  table_info <- list(name = table_name, data = frq_data)
  
  # Append the table info to the list
  neutral_model_tables <- c(neutral_model_tables, list(table_info))
}


# Print the list of neutral_model_tables
#print(neutral_model_tables)

```

# 2: Computing expected heterozygosity

```{r}
calculate_expected_heterozygosity <- function(p) {
  # Calculate expected heterozygosity
  heterozygosity <- 2 * p * (1 - p)
  
  # Return the result
  return(heterozygosity)
}

```

## 2.1: Empirical ROH-Hotspots

```{r}

for (i in seq_along(empirical_hotspot_tables)) {
  # Extract table name and data frame
  table_info <- empirical_hotspot_tables[[i]]
  table_data <- table_info$data
  
  # Calculate expected heterozygosity for each window
  window_H_e_list <- c()  # Initialize an empty list to store expected heterozygosity values
  
  # Loop through each row in the table data
  for (j in 1:nrow(table_data)) {
    # Extract the MAF (p value)
    p <- table_data[j, "MAF"]
    
    # Calculate expected heterozygosity using the provided function
    expected_heterozygosity <- calculate_expected_heterozygosity(p)
    
    # Append the calculated expected heterozygosity to the list
    window_H_e_list <- c(window_H_e_list, expected_heterozygosity)
  }
  
  # Assign the calculated expected heterozygosity list to the H_e attribute of table_info
  empirical_hotspot_tables[[i]]$H_e_list <- window_H_e_list
  empirical_hotspot_tables[[i]]$Average_H_e <- mean(empirical_hotspot_tables[[i]]$H_e_list)
}

#View(empirical_hotspot_tables)

```

## 2.2: Neutral model

```{r}
for (i in seq_along(neutral_model_tables)) {
  # Extract table name and data frame
  table_info <- neutral_model_tables[[i]]
  table_data <- table_info$data
  
  # Calculate expected heterozygosity for each window
  window_H_e_list <- c()  # Initialize an empty list to store expected heterozygosity values
  
  # Loop through each row in the table data
  for (j in 1:nrow(table_data)) {
    # Extract the MAF (p value)
    p <- table_data[j, "MAF"]
    
    # Calculate expected heterozygosity using the provided function
    expected_heterozygosity <- calculate_expected_heterozygosity(p)
    
    # Append the calculated expected heterozygosity to the list
    window_H_e_list <- c(window_H_e_list, expected_heterozygosity)
  }
  
  # Assign the calculated expected heterozygosity list to the H_e attribute of table_info
  neutral_model_tables[[i]]$H_e_list <- window_H_e_list
  neutral_model_tables[[i]]$Average_H_e <- mean(neutral_model_tables[[i]]$H_e_list)
}

#View(neutral_model_tables)

```
## 2.3: Neutral windows
```{r}


# Define the window size
window_size <- 100 * 10^3
#window_size <- 2000 * 10^3

# Initialize an empty list to store windows for each simulation
simulation_windows <- list()

# Iterating through each simulation
for (sim_index in seq_along(neutral_model_tables)) {
  # Get the SNP positions and H_e values for the current simulation
  snp_positions <- neutral_model_tables[[sim_index]][["data"]][["POS"]]
  he_values <- neutral_model_tables[[sim_index]][["H_e_list"]]
  
  # Determine the number of windows needed
  num_windows <- ceiling(max(snp_positions) / window_size)
  
  # Initialize an empty list to store windows for the current simulation
  sim_windows <- list()
  
  # Iterate through each window
  for (window_index in seq_len(num_windows)) {
    # Determine the start and end positions of the current window
    window_start <- (window_index - 1) * window_size
    window_end <- window_start + window_size
    
    # Find the indices of SNPs within the current window
    snp_indices <- which(snp_positions >= window_start & snp_positions < window_end)
    
    # Extract the SNP positions and H_e values for the current window
    window_snp_positions <- snp_positions[snp_indices]
    window_he_values <- he_values[snp_indices]
    
    # Create a sub-table for the current window
    window_data <- data.frame(POS = window_snp_positions, H_e = window_he_values)
    
    # Append the sub-table to the list of windows for the current simulation
    sim_windows[[window_index]] <- window_data
  }
  
  # Append the list of windows for the current simulation to the main list
  simulation_windows[[sim_index]] <- sim_windows
}


#View(simulation_windows)


# Create a list to store the average H_e values for each simulation
Simulation_windows_avg_he <- list()

# Iterate over each simulation
for (i in seq_along(simulation_windows)) {
    # Create a vector to store the average H_e values for each window in the current simulation
    Simulation_windows_avg_he[[i]] <- numeric(length(simulation_windows[[i]]))
    
    # Iterate over each window in the current simulation
    for (j in seq_along(simulation_windows[[i]])) {
        # Calculate the average H_e value for the current window

        # Using "na.rm = TRUE" To remove windows not having SNP-markers in them
        
        window_avg_he <- mean(simulation_windows[[i]][[j]][["H_e"]], na.rm = TRUE) 
        
        # Store the average H_e value for the current window
        Simulation_windows_avg_he[[i]][j] <- window_avg_he
    }
    # Removing NaN values for the current simulation
    # (Windows without any markers)
    Simulation_windows_avg_he[[i]] <- Simulation_windows_avg_he[[i]][!is.na(Simulation_windows_avg_he[[i]])]

}

# Calculate the mean H_e value for each simulation
simulations_mean_he_window_based <- sapply(Simulation_windows_avg_he, mean)




```

##


# 3: Sweep test

## 3.1: Neutral model - H_e distribution


```{r}

# Determine the number of bins you want
num_bins <- 20  

histogram_title <-  paste("H_e Distribution of the 20 simulations - Windowsize:",window_size,"bp")

# Create a histogram with custom breaks
hist(simulations_mean_he_window_based, breaks = num_bins, main = histogram_title, xlab = "H_e")

# Calculate the 5th percentile
percentile_5 <- quantile(simulations_mean_he_window_based, 0.05)

# Add a vertical line at the 5th percentile
abline(v = percentile_5, col = "red", lty = 2)

# Add a legend
legend("topright", legend = paste("5th percentile =", round(percentile_5, 4)), col = "red", lty = 2)
```


### SNP based averages

```{r}
# Extract Average_H_e values from all tables in neutral_model_tables
sim_average_H_e_values <- sapply(neutral_model_tables, function(table) table[["Average_H_e"]])

# Determine the number of bins you want
num_bins <- 20  

# Create a histogram with custom breaks
hist(sim_average_H_e_values, breaks = num_bins, main = "Average SNP H_e per simulation - Distribution", xlab = "H_e")

# Calculate the 5th percentile
percentile_5_SNP_based_average <- quantile(sim_average_H_e_values, 0.05)

# Add a vertical line at the 5th percentile
abline(v = percentile_5_SNP_based_average, col = "red", lty = 2)

# Add a legend
legend("topright", legend = paste("5th percentile =", round(percentile_5_SNP_based_average, 4)), col = "red", lty = 2)
```

## 3.2: ROH-Hotspots Selection testing

Selection testing for the different ROH-Hotspot windows.

ROH-Hotspots with an average H_e lower than **or** equal to (\<=) the
5th percentile of the H_e-distribution for the simulated neutral model,
**are ROH-Hotspots deemed as being under selection**.

```{r}
setwd(output_dir_sweep_test)

# Defining the dataframe that will store the selection testing results
ROH_hotspots_selection_testing <- data.frame(
  Name = character(),  
  Under_selection = character(),
  Average_H_e = numeric() 
)


for (i in seq_along(empirical_hotspot_tables)) {
  # Check if Average_H_e is <= percentile_5 for the current table (ROH-hotspot)
  if (empirical_hotspot_tables[[i]][["Average_H_e"]] <= percentile_5) {
    # # If under selection, append the name and Average_H_e value with "Yes"
    ROH_hotspots_selection_testing <- rbind(ROH_hotspots_selection_testing, data.frame(
      Name = empirical_hotspot_tables[[i]][["name"]],
      Under_selection = "Yes",  # Marking as "Yes" if under selection
      Average_H_e = empirical_hotspot_tables[[i]][["Average_H_e"]]
    ))
  } else {
    # If not under selection, append the name and Average_H_e value with "No" 
    ROH_hotspots_selection_testing <- rbind(ROH_hotspots_selection_testing, data.frame(
      Name = empirical_hotspot_tables[[i]][["name"]],
      Under_selection = "No",  # Marking as "No" if not under selection
      Average_H_e = empirical_hotspot_tables[[i]][["Average_H_e"]]
    ))
  }
}

# Sort the data frame by Average_H_e values in ascending order
ROH_hotspots_selection_testing <- ROH_hotspots_selection_testing[order(ROH_hotspots_selection_testing$Average_H_e), ]

# Plot histogram of hotspot Average_H_e values
hist(ROH_hotspots_selection_testing$Average_H_e, breaks = 20, main = "ROH-Hotspots Distribution of Average H_e Values", xlab = "H_e")

# Add a vertical line at the 5th percentile
abline(v = percentile_5, col = "red", lty = 2)

# Add legend for the 5th percentile line
legend("topright", legend = paste("5th percentile =", round(percentile_5, 4)), col = "red", lty = 2)


cat("ROH-hotspot selection testing results:\n")
kable(ROH_hotspots_selection_testing, row.names = FALSE)

# Saving the results in a .tsv-file
write.table(ROH_hotspots_selection_testing, "ROH_hotspots_selection_testing_results.tsv", sep = "\t", row.names = FALSE,quote = FALSE)



```
