---
title: "ROH-hotspot identification"
output:
  html_document:
    toc: true
    toc_depth: 3  
date: "2024-05-19"
editor_options: 
  markdown: 
    wrap: 72
---

# 0: Preparation

Defining the input and output files

```{r}
# Clean the working environment
rm(list = ls())

knitr::opts_chunk$set(echo = TRUE)


####################################  
# Defining the input files
#################################### 

Selection_strength_test_dir <- Sys.getenv("Selection_strength_test_dir")

Sweep_test_dir <-  Sys.getenv("Sweep_test_dir")

############### 
## Empirical ###
###############

### ROH hotspots ###
Empirical_data_ROH_hotspots_dir  <- Sys.getenv("Empirical_data_ROH_hotspots_dir")

Empirical_data_autosome_ROH_freq_dir <- Sys.getenv("Empirical_data_autosome_ROH_freq_dir")
### Inbreeding coefficient ###

Empirical_data_F_ROH_dir  <- Sys.getenv("Empirical_data_F_ROH_dir")

### Expected Heterozygosity distribution ###
Empirical_data_H_e_dir <- Sys.getenv("Empirical_data_H_e_dir")

############### 
## Simulated ###
###############

### ROH hotspots ###
Neutral_model_ROH_hotspots_dir <- Sys.getenv("Neutral_model_ROH_hotspots_dir")
Neutral_model_autosome_ROH_freq_dir <- Sys.getenv("Neutral_model_autosome_ROH_freq_dir")
Selection_model_ROH_hotspots_dir  <- Sys.getenv("Selection_model_ROH_hotspots_dir")
Selection_model_autosome_ROH_freq_dir <- Sys.getenv("Selection_model_autosome_ROH_freq_dir")

### Inbreeding coefficient ###
Neutral_model_F_ROH_dir  <- Sys.getenv("Neutral_model_F_ROH_dir")
Selection_model_F_ROH_dir  <- Sys.getenv("Selection_model_F_ROH_dir")

### Expected Heterozygosity distribution ###
Neutral_model_H_e_dir <- Sys.getenv("Neutral_model_H_e_dir")
Selection_model_H_e_dir <- Sys.getenv("Selection_model_H_e_dir")


histogram_line_sizes <- 3
empirical_data_color <- "darkgreen"
neutral_model_color <- "blue" 
selection_model_color <- "purple"


# Sys.getenv()  

# # Set the working directory for notebook chunks
# knitr::opts_knit$set(root.dir = output_dir_sweep_test)

```


## Loading libraries

```{r library()}
library(knitr)
library(ggplot2)
```
#1: ROH-Hotspots

## 1.1 : Autosome ROH-frequencies

### 1.1.1 : Empirical - ROH frequency

```{r Empirical - ROH frequency}
setwd(Empirical_data_autosome_ROH_freq_dir)
# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- ".*ROH_freq.*\\.tsv$"
population_ROH_freq_files <- list.files(pattern = pattern)
# population_ROH_freq_files <- list.files(path = Empirical_data_autosome_ROH_freq_dir, pattern = pattern)


#population_ROH_freq_files
# Extracting the ROH-hotspot threshold value from the suffix of the filename
parts <- unlist(strsplit(population_ROH_freq_files[1], "threshold_")) # Split the string by "threshold_"
# Extract the decimal number using regular expressions
Empirical_data_ROH_hotspot_threshold <- as.numeric(gsub("\\.tsv", "", unlist(strsplit(parts[length(parts)], "_"))[1]))


# Extract chromosome numbers from filenames
chr_numbers <- as.numeric(gsub(".*CHR(\\d+)_.*", "\\1", population_ROH_freq_files))
# cat("CHR Values:", chr_numbers, "\n")


# Sort filenames based on chromosome numbers
sorted_population_ROH_freq_files <- population_ROH_freq_files[order(chr_numbers)]

# Initialize an empty list to store the ROH-frequency data
ROH_freq_table_Empirical_Data <- list()

# Loop through each sorted .tsv file
for (file in sorted_population_ROH_freq_files) {

  file_name <- file
  
  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)
  
  # Remove "#" from the header and split it into column names
  column_names <- strsplit(sub("#", "", header), "\t")[[1]]
  
  # Read the .tsv frequency file into a data frame
  ROH_freq_data <- read.table(file, header = TRUE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  
  # Add chromosome_name as an attribute to the data frame
  chr_num <- as.numeric(gsub(".*CHR(\\d+)_.*", "\\1", file))
  attr(ROH_freq_data, "chromosome_name") <- chr_num
  
  # Create a list with table name and corresponding data frame
  table_info <- list(chromosome_name = chr_num, filename = file_name, data = ROH_freq_data)  # Added chromosome_name here
  
  # Append the table info to the list
  ROH_freq_table_Empirical_Data <- c(ROH_freq_table_Empirical_Data, list(table_info))
}

ROH_freq_table_Empirical_Data$ROH_hotspot_threshold <- Empirical_data_ROH_hotspot_threshold

# ROH_freq_table_Empirical_Data
#View(ROH_freq_table_Empirical_Data) 

```

### 1.1.2: Neutral Model - ROH frequency

```{r Neutral Model - ROH frequency}
setwd(Neutral_model_autosome_ROH_freq_dir)
# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- ".*ROH_freq.*\\.tsv$"

# neutral_model_ROH_freq_files <- list.files(pattern = pattern)
neutral_model_ROH_freq_files <- list.files(path = Neutral_model_autosome_ROH_freq_dir, pattern = pattern)


# # Extract the population name from the file names
# empirical_population_name <- sub("^(.*?)_CHR(0-9)_ROH_freq.*", "//1", population_F_ROH_file)

# Extract simulation numbers from the filename
sim_number_pattern <- ".*sim_(\\d+)_.*" 
sim_numbers <- as.numeric(gsub(sim_number_pattern, "\\1", neutral_model_ROH_freq_files))
# cat("CHR Values:", chr_numbers, "\n")


# Sort filenames based on chromosome numbers
sorted_neutral_model_ROH_freq_files <- neutral_model_ROH_freq_files[order(sim_numbers)]

# Initialize an empty list to store the ROH-frequency data
ROH_freq_tables_Neutral_Model <- list()

# Loop through each sorted .tsv file
for (file in sorted_neutral_model_ROH_freq_files) {

  # Extracting the ROH-hotspot threshold value from the suffix of the filename
  parts <- unlist(strsplit(file, "threshold_")) # Split the string by "threshold_"
  # Extract the decimal number using regular expressions
  simulation_ROH_hotspot_threshold <- as.numeric(gsub("\\.tsv", "", unlist(strsplit(parts[length(parts)], "_"))[1]))
  
  # # Print the extracted values
  # cat("Threshold Values:", threshold_values, "\n")
  
  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)
  
  # Remove "#" from the header and split it into column names
  column_names <- strsplit(sub("#", "", header), "\t")[[1]]
  
  # Read the .tsv frequency file into a data frame
  ROH_freq_data <- read.table(file, header = TRUE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  
  # Add chromosome_name as an attribute to the data frame
  sim_num <- as.numeric(gsub(sim_number_pattern, "\\1", file))
  attr(ROH_freq_data, "Simulation_number") <- sim_num
  
  # Create a list with table name and corresponding data frame
  table_info <- list(Simulation_number = sim_num, filename = file, data = ROH_freq_data,ROH_Hotspot_threshold = simulation_ROH_hotspot_threshold)  # Added chromosome_name here
  
  # Append the table info to the list
  ROH_freq_tables_Neutral_Model <- c(ROH_freq_tables_Neutral_Model, list(table_info))
}

# ROH_freq_tables_Neutral_Model$ROH_hotspot_threshold <- neutral_model_ROH_hotspot_threshold

# Extract all ROH-hotspot thresholds from ROH_freq_tables_Neutral_Model
all_ROH_hotspot_thresholds <- unlist(lapply(ROH_freq_tables_Neutral_Model, function(table) table$ROH_Hotspot_threshold))

# Calculate the overall average Avg_F_ROH
Avg_ROH_hotspot_threshold <- mean(all_ROH_hotspot_thresholds)
ROH_freq_tables_Neutral_Model$Avg_ROH_hotspot_threshold <- Avg_ROH_hotspot_threshold

# ROH_freq_tables_Neutral_Model

#View(ROH_freq_tables_Neutral_Model)
```

### 1.1.3: Selection Model

```{r Selection Model - ROH frequency}
# Set the working directory to the directory containing the selection model ROH frequency files
setwd(Selection_model_autosome_ROH_freq_dir)

# Pattern for finding files containing "ROH_freq" and ending with ".tsv"
pattern <- ".*ROH_freq.*\\.tsv$"
selection_model_ROH_freq_files <- list.files(pattern = pattern)

# Extract simulation numbers from the filename
sim_number_pattern <- ".*sim_(\\d+)_.*" 
sim_numbers <- as.numeric(gsub(sim_number_pattern, "\\1", selection_model_ROH_freq_files))
sim_name <- sub("^(.*?)_ROH_freq.*", "\\1", selection_model_ROH_freq_files)




# sim_name <- sub("^(.*?)_F_ROH.*", "\\1", simulation_F_ROH_files)

# Preallocate sim_info as an empty data frame
sim_info <- data.frame(sim_name = character(), simulation_number = numeric(), file_name = character(), stringsAsFactors = FALSE)

# Combine simulation name, number, and file name
sim_info <- data.frame(sim_name = sim_name, simulation_number = sim_numbers, file_name =selection_model_ROH_freq_files)
sim_info <- sim_info[order(sim_info$simulation_number), ]


# # Sort filenames based on simulation numbers
# sorted_selection_model_ROH_freq_files <- selection_model_ROH_freq_files[order(sim_numbers)]

# Initialize an empty list to store the selection model tables
ROH_freq_tables_Selection_Model <- list()

# Loop through each sorted .tsv file
for (i in 1:length(sim_info$sim_name)) {
  # Get the file name
  file <- sim_info$file_name[i]
  # Extract simname from the file name
  simname_from_file <- sub("^(.*?)_ROH_freq.*", "\\1", file)
  
  # Check if the simname from the file matches with the simname from the dataframe
  if (simname_from_file != sim_info$sim_name[i]) {
    print(paste0("simname_from_file:", simname_from_file))
    print(paste0("sim_info$sim_name[i]:", sim_info$sim_name[i]))
    stop("Error: Simname from file does not match with simname from dataframe.")
  }



  
  # Extracting the ROH-hotspot threshold value from the suffix of the filename
  parts <- unlist(strsplit(file, "threshold_")) # Split the string by "threshold_"
  # Extract the decimal number using regular expressions
  simulation_ROH_hotspot_threshold <- as.numeric(gsub("\\.tsv", "", unlist(strsplit(parts[length(parts)], "_"))[1]))
  
  # # Read the header line
  # con <- file(file, "r")
  # header <- readLines(con, n = 1)
  # close(con)
  # 
  # # Remove "#" from the header and split it into column names
  # column_names <- strsplit(sub("#", "", header), "\t")[[1]]
  # 
  # # Read the .tsv frequency file into a data frame
  # ROH_freq_data <- read.table(file, header = TRUE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  # 
  
  
  # Add simulation_number as an attribute to the data frame
  sim_num <- as.numeric(gsub(sim_number_pattern, "\\1", file))
  attr(ROH_freq_data, "Simulation_number") <- sim_num
  
  # Extract the selection coefficient from the file name
  selection_coefficient <- sub(".*(selection_model_s\\d+_chr\\d+).*", "\\1", file)

  # Check if the selection coefficient already exists in the list
  if (!(selection_coefficient %in% names(ROH_freq_tables_Selection_Model))) {
    # If it doesn't exist, create a list for it
    ROH_freq_tables_Selection_Model[[selection_coefficient]] <- list()
  }
  

  # Create a list with table name and corresponding data frame
  table_info <- list(Simulation_number = sim_num, filename = file,ROH_Hotspot_threshold =    simulation_ROH_hotspot_threshold)  # Added ROH_Hotspot_threshold here
  
  # Append the table info to the list under selection_coefficient
  ROH_freq_tables_Selection_Model[[selection_coefficient]] <- c(ROH_freq_tables_Selection_Model[[selection_coefficient]], list(table_info))
}


# Calculate overall average ROH hotspot threshold for each selection coefficient
for (selection_coefficient in names(ROH_freq_tables_Selection_Model)) {
  all_thresholds <- unlist(lapply(ROH_freq_tables_Selection_Model[[selection_coefficient]], function(table) table$ROH_Hotspot_threshold))
  overall_avg_threshold <- mean(all_thresholds)
  ROH_freq_tables_Selection_Model[[selection_coefficient]]$Avg_ROH_hotspot_threshold <- overall_avg_threshold
}

# View the resulting nested structure
#View(ROH_freq_tables_Selection_Model)

```

## 1.4 ROH-hotspot threshold summary

```{r}
cat("ROH-hotspot selection testing results://n")

# Initialize an empty vector to store F_ROH values for the different selection coefficients
selection_model_values_list <- c()
selection_model_names_list <- c(rownames(summary(ROH_freq_tables_Selection_Model)))

# Loop through each selection_coefficient in ROH_freq_tables_Selection_Model
for (selection_coefficient in ROH_freq_tables_Selection_Model) {
  # Extract the Avg_ROH_hotspot_threshold value from the selection_coefficient
  Avg_ROH_hotspot_threshold <- selection_coefficient$Avg_ROH_hotspot_threshold
  # Extract the model name
  model_name <- selection_coefficient
  # Append values to the lists
  selection_model_values_list <- c(selection_model_values_list, Avg_ROH_hotspot_threshold)
  # selection_model_names_list <- c(selection_model_names_list, model_name)
}



# Add overAvg_ROH_hotspot_threshold from ROH_freq_tables_Neutral_Model
neutral_model_value <- ROH_freq_tables_Neutral_Model[["Avg_ROH_hotspot_threshold"]]

# Add Avg_ROH_hotspot_threshold from ROH_freq_table_Empirical_Data
empirical_model_value <- ROH_freq_table_Empirical_Data[["ROH_hotspot_threshold"]]

# Combine all values into a data frame
ROH_hotspot_threshold_values <- data.frame(
  Model = c(rep("Selection", length(selection_model_values_list)), "Neutral", "Empirical"),
  Avg_ROH_hotspot_threshold = c(selection_model_values_list, neutral_model_value, empirical_model_value)
)

# Update the Model column for selection models
ROH_hotspot_threshold_values$Model[ROH_hotspot_threshold_values$Model == "Selection"] <- selection_model_names_list

# Sort the data frame based on Inbreeding coefficient column
ROH_hotspot_threshold_values_sorted <- ROH_hotspot_threshold_values[order(ROH_hotspot_threshold_values$Avg_ROH_hotspot_threshold), ]


# # Print the table using knitr::kable()
# knitr::kable(ROH_hotspot_threshold_values, row.names = FALSE)

# Print the table using knitr::kable()
knitr::kable(ROH_hotspot_threshold_values_sorted, row.names = FALSE)

```

# 2: Inbreeding coefficient

## 2.1 Empirical data

```{r}
# Set the working directory to the directory containing the F_ROH files for the empirical data
setwd(Empirical_data_F_ROH_dir)

# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- "^.*F_ROH.*.tsv$"
population_F_ROH_file <- list.files(pattern = pattern)

# Extract the population name from the file names
empirical_population_name <- sub("^(.*?)_F_ROH.*", "\\1", population_F_ROH_file)

# Combine population name, number, and file name
population_info <- data.frame(empirical_population_name = empirical_population_name, file_name = population_F_ROH_file)
population_info <- population_info[order(population_info$file_name), ]

# Initialize an empty list to store the data
F_ROH_table_Empirical_Data <- list()

# Loop through each .tsv file
for (i in 1:length(population_info$empirical_population_name)) {

  # Get the file name
  file <- population_info$file_name[i]

  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)

  # Remove "#" from the header and split it into column names
  column_names <- sub("#", "", header)
  column_names <- strsplit(column_names, "\t")[[1]]

  # Read the .tsv frequency file into a data frame
  F_ROH_data <- read.table(file, header = TRUE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)

  # Add empirical_population_name as an attribute to the data frame
  attr(F_ROH_data, "empirical_population_name") <- population_info$empirical_population_name[i]

  # Add filename as an attribute to the data frame
  attr(F_ROH_data, "filename") <- file_name

  # Calculate the mean of the "F_ROH" column
  avg_F_ROH_population <- mean(F_ROH_data$F_ROH)
  
  # Create a list with table name and corresponding data frame
  table_info <- list(empirical_population_name = population_info$empirical_population_name[i], filename = file, data = F_ROH_data,Avg_F_ROH = avg_F_ROH_population )  # Added empirical_population_name here

  # Append the table info to the list
  F_ROH_table_Empirical_Data <- c(F_ROH_table_Empirical_Data, table_info)
}

# Creating a histogram showing the spread in F_ROH values across the empirical population 

histogram_title <- paste0("F_ROH distribution for ",empirical_population_name)
hist(F_ROH_data$F_ROH, main = histogram_title, xlab = "F_ROH", ylab = "Frequency", col = "skyblue")


empirical_avg_F_ROH_legend_text <- paste(empirical_population_name," Average: ", round(F_ROH_table_Empirical_Data[["Avg_F_ROH"]], 3))

# Add a vertical line for the average F_ROH of the empirical population
abline(v = F_ROH_table_Empirical_Data[["Avg_F_ROH"]], col = empirical_data_color, lwd = histogram_line_sizes)
# Add legend
legend("topright", legend = empirical_avg_F_ROH_legend_text,
       col = empirical_data_color, lty = 1, cex = 0.8, text.col = "black")


# Print the overall average Avg_F_ROH
cat("Overall Average Avg_F_ROH for ",empirical_population_name,":",F_ROH_table_Empirical_Data[["Avg_F_ROH"]], "//n")


# View the modified data structure
#View(F_ROH_table_Empirical_Data)

```

## 2.2 Neutral Model

```{r}
# Set the working directory to the directory containing the F_ROH files for the empirical data
setwd(Neutral_model_F_ROH_dir)

# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- "^.*F_ROH.*.tsv$"
simulation_F_ROH_files <- list.files(pattern = pattern)

# Extract the simulation name from the file names
sim_name <- sub("^(.*?)_F_ROH.*", "////1", simulation_F_ROH_files)

# Extract the simulation number after "sim_"
simulation_numbers <- as.integer(sub("^sim_(////d+)_.*", "////1", simulation_F_ROH_files))

# Combine simulation name, number, and file name
sim_info <- data.frame(sim_name = sim_name, simulation_number = simulation_numbers, file_name = simulation_F_ROH_files)
sim_info <- sim_info[order(sim_info$simulation_number), ]

# Initialize an empty list to store Simulated model tables
F_ROH_tables_Neutral_Model <- list()

# Loop through each .tsv file
for (i in 1:length(sim_info$sim_name)) {
 
  # Get the file name
  file <- sim_info$file_name[i]

  # Extract the table name from the file name
  file_name <- gsub("////.tsv$", "", file)
  
  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)
  
  # Remove "#" from the header and split it into column names
  column_names <- sub("#", "", header)
  column_names <- strsplit(column_names, "\t")[[1]]
  
  # Read the .tsv frequency file into a data frame
  F_ROH_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)
  
  # Add sim_name as an attribute to the data frame
  attr(F_ROH_data, "sim_name") <- sim_info$sim_name[i]
  
  # Create a list with table name and corresponding data frame
  table_info <- list(sim_name = sim_info$sim_name[i], filename = file_name, data = F_ROH_data)  # Added sim_name here
  
  # Append the table info to the list
  F_ROH_tables_Neutral_Model <- c(F_ROH_tables_Neutral_Model, list(table_info))
}


# Calculating Average F_ROH for each table

# Loop through each table in F_ROH_tables_Neutral_Model
for (i in seq_along(F_ROH_tables_Neutral_Model)) {
  
  # Calculate the mean of the "F_ROH" column in the current table
  avg_F_ROH <- mean(F_ROH_tables_Neutral_Model[[i]]$data$F_ROH)
  
  # Add Avg_F_ROH as a variable to the table's data frame
  F_ROH_tables_Neutral_Model[[i]]$Avg_F_ROH <- avg_F_ROH
  
  
}

#View(F_ROH_tables_Neutral_Model)


# Extract all Avg_F_ROH values from F_ROH_tables_Neutral_Model
all_avg_F_ROH <- unlist(lapply(F_ROH_tables_Neutral_Model, function(table) table$Avg_F_ROH))

# Remove any non-numeric values
all_avg_F_ROH <- all_avg_F_ROH[!is.na(all_avg_F_ROH) & is.numeric(all_avg_F_ROH)]

# Calculate the overall average Avg_F_ROH
overall_avg_F_ROH <- mean(all_avg_F_ROH)
F_ROH_tables_Neutral_Model$overall_avg_F_ROH <- overall_avg_F_ROH

# Set the plot size
options(repr.plot.width = 10, repr.plot.height = 6)

# Create histogram for simulated data
hist(all_avg_F_ROH, main = "Average F_ROH for the Neutral Model", xlab = "F_ROH", ylab = "Frequency", col = "skyblue")

# Determine the location of the legend based on the comparison
if (overall_avg_F_ROH > F_ROH_table_Empirical_Data[["Avg_F_ROH"]]) {
  simulated_line_location <- "topright"
  empirical_line_location <- "topleft"
} else {
  simulated_line_location <- "topleft"
  empirical_line_location <- "topright"
}


# Add a red vertical line for the overall average Avg_F_ROH
abline(v = overall_avg_F_ROH, col = neutral_model_color, lwd = histogram_line_sizes)

# Add legend for the red line
legend(simulated_line_location, legend = paste("Neutral Model Average: ", round(overall_avg_F_ROH, 4)),
       col = neutral_model_color, lty = 1, cex = 0.8, text.col = "black")

# Add a blue vertical line for the average F_ROH of the empirical population
abline(v = F_ROH_table_Empirical_Data[["Avg_F_ROH"]], col = empirical_data_color, lwd = histogram_line_sizes)

# Add legend for the green line
legend(empirical_line_location, legend = empirical_avg_F_ROH_legend_text,
       col = empirical_data_color, lty = 1, cex = 0.8, text.col = "black", xjust = 1, yjust = 1)

# Reset par settings to default after plotting
par(mfrow = c(1, 1))



# Print the overall average Avg_F_ROH
cat("Overall Average Avg_F_ROH:", overall_avg_F_ROH, "//n")



```

## 2.3 Selection Model

```{r}
# Set the working directory to the directory containing the F_ROH files for the empirical data
setwd(Selection_model_F_ROH_dir)

# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- "^.*F_ROH.*.tsv$"
simulation_F_ROH_files <- list.files(pattern = pattern)


# Extract simulation numbers from the filename
sim_number_pattern <- ".*sim_(\\d+)_.*" 
simulation_numbers <- as.numeric(gsub(sim_number_pattern, "\\1", simulation_F_ROH_files))

# # Extract the simulation number after "sim_"
# simulation_numbers <- as.integer(sub("^sim_(////d+)_.*", "////1", simulation_F_ROH_files))
# simulation_numbers <- as.integer(sub("^sim_(////d+)_.*", "////1", simulation_F_ROH_files))

sim_name <- sub("^(.*?)_F_ROH.*", "\\1", simulation_F_ROH_files)

# Combine simulation name, number, and file name
sim_info <- data.frame(sim_name = sim_name, simulation_number = simulation_numbers, file_name = simulation_F_ROH_files)
sim_info <- sim_info[order(sim_info$simulation_number), ]

# Initialize an empty list to store Simulated model tables
F_ROH_tables_Selection_Model <- list()

# Loop through each .tsv file
for (i in 1:length(sim_info$sim_name)) {

  # Get the file name
  file <- sim_info$file_name[i]

  # Extract the selection_model_type from the file name
  selection_model_type <- sub("^sim_[0-9]+_(.*?)_F_ROH.*", "\\1", file)
  
  # Check if the selection_model_type already exists in the list
  if (!(selection_model_type %in% names(F_ROH_tables_Selection_Model))) {
    # If it doesn't exist, create a list for it
    F_ROH_tables_Selection_Model[[selection_model_type]] <- list()
  }

  # Extract simname from the file name
  simname_from_file <- sub("^(.*?)_F_ROH.*", "\\1", file)
  
  # Check if the simname from the file matches with the simname from the dataframe
  if (simname_from_file != sim_info$sim_name[i]) {
    stop("Error: Simname from file does not match with simname from dataframe.")
  }

  # Read the header line
  con <- file(file, "r")
  header <- readLines(con, n = 1)
  close(con)

  # Remove "#" from the header and split it into column names
  column_names <- sub("#", "", header)
  column_names <- strsplit(column_names, "\\t")[[1]]

  # Read the .tsv frequency file into a data frame
  F_ROH_data <- read.table(file, header = FALSE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)

  # Add sim_name as an attribute to the data frame
  attr(F_ROH_data, "sim_name") <- sim_info$sim_name[i]

  # Assign the file name to file_name
  file_name <- sub("\\.tsv$", "", sim_info$file_name[i])

  # Create a list with table name and corresponding data frame
  table_info <- list(sim_name = sim_info$sim_name[i], filename = file_name, data = F_ROH_data)  # Fixed filename assignment

  # Append the table info to the list under selection_model_type
  F_ROH_tables_Selection_Model[[selection_model_type]] <- c(F_ROH_tables_Selection_Model[[selection_model_type]], list(table_info))
}


# Calculating Average F_ROH for each table

# Loop through each selection_coefficient
for (selection_coefficient in names(F_ROH_tables_Selection_Model)) {
  # Loop through each table in the selection_coefficient
  for (i in seq_along(F_ROH_tables_Selection_Model[[selection_coefficient]])) {
    # Calculate the mean of the "F_ROH" column in the current sub-subtable
    avg_F_ROH <- mean(F_ROH_tables_Selection_Model[[selection_coefficient]][[i]]$data$F_ROH)
    # Add Avg_F_ROH as a variable to the sub-subtable's data frame
    F_ROH_tables_Selection_Model[[selection_coefficient]][[i]]$pop_Avg_F_ROH <- avg_F_ROH
  }
  
  # Extract all pop_Avg_F_ROH values from F_ROH_tables_Selection_Model
  all_pop_avg_F_ROH <- unlist(lapply(F_ROH_tables_Selection_Model[[selection_coefficient]], function(table) table$pop_Avg_F_ROH))
  # print(all_pop_avg_F_ROH)
  
  # Calculate the overall average pop_Avg_F_ROH for the current selection coefficient
  overall_avg_F_ROH <- mean(all_pop_avg_F_ROH)
  
  # Set all_avg_F_ROH as a variable in the selection coefficient
  F_ROH_tables_Selection_Model[[selection_coefficient]]$all_avg_F_ROH <- overall_avg_F_ROH
  
  
  # Set the plot size
  options(repr.plot.width = 10, repr.plot.height = 6)
  
  
  # Creating a histogram showing the spread in average F_ROH values across each technical replicate 
  # for the current selection coefficient!
  
  histogram_title <- paste0("Average F_ROH distribution for ",selection_coefficient)
  hist(all_pop_avg_F_ROH, main = histogram_title, xlab = "F_ROH", ylab = "Frequency", col = "skyblue")
  
  # Determine the location of the legend based on the comparison
  if (overall_avg_F_ROH > F_ROH_table_Empirical_Data[["Avg_F_ROH"]]) {
    simulated_line_location <- "topright"
    empirical_line_location <- "topleft"
  } else {
    simulated_line_location <- "topleft"
    empirical_line_location <- "topright"
  }
  
  # Add a vertical line for the overall average Avg_F_ROH of the current selection model
  abline(v = overall_avg_F_ROH, col = selection_model_color, lwd = histogram_line_sizes)
  
  # Add legend for the red line
  legend(simulated_line_location, legend = paste("Selection Coefficient Average: ", round(overall_avg_F_ROH, 4)),
       col = selection_model_color, lty = 1, cex = 0.8, text.col = "black")
  
  # Add a vertical line for the average F_ROH of the empirical population
  abline(v = F_ROH_table_Empirical_Data[["Avg_F_ROH"]], col = empirical_data_color, lwd = histogram_line_sizes)

  # Add legend for the empirical line
  legend(empirical_line_location, legend = empirical_avg_F_ROH_legend_text,
         col = empirical_data_color, lty = 1, cex = 0.8, text.col = "black", xjust = 1, yjust = 1)
  
  # Reset par settings to default after plotting
  par(mfrow = c(1, 1))

  # Print the overall average Avg_F_ROH
  cat("Overall Average Avg_F_ROH for ",selection_coefficient,":",overall_avg_F_ROH, "//n")
}


#View(F_ROH_tables_Selection_Model)
```

## 2.4 F_ROH summary

```{r}
cat("ROH-hotspot selection testing results://n")

# Initialize an empty vector to store F_ROH values for the different selection coefficients
selection_model_values_list <- c()
selection_model_names_list <- c(rownames(summary(F_ROH_tables_Selection_Model)))

# Loop through each selection_coefficient in F_ROH_tables_Selection_Model
for (selection_coefficient in F_ROH_tables_Selection_Model) {
  # Extract the all_avg_F_ROH value from the selection_coefficient
  all_avg_F_ROH <- selection_coefficient$all_avg_F_ROH
  # Extract the model name
  model_name <- selection_coefficient
  # Append values to the lists
  selection_model_values_list <- c(selection_model_values_list, all_avg_F_ROH)
  # selection_model_names_list <- c(selection_model_names_list, model_name)
}



# Add overall_avg_F_ROH from F_ROH_tables_Neutral_Model
neutral_model_value <- F_ROH_tables_Neutral_Model[["overall_avg_F_ROH"]]

# Add Avg_F_ROH from F_ROH_table_Empirical_Data
empirical_model_value <- F_ROH_table_Empirical_Data[["Avg_F_ROH"]]

# Combine all values into a data frame
F_ROH_values <- data.frame(
  Model = c(rep("Selection", length(selection_model_values_list)), "Neutral", "Empirical"),
  Avg_F_ROH = c(selection_model_values_list, neutral_model_value, empirical_model_value)
)

# Update the Model column for selection models
F_ROH_values$Model[F_ROH_values$Model == "Selection"] <- selection_model_names_list

# Sort the data frame based on Inbreeding coefficient column
F_ROH_values_sorted <- F_ROH_values[order(F_ROH_values$Avg_F_ROH), ]


# # Print the table using knitr::kable()
# knitr::kable(F_ROH_values, row.names = FALSE)

# Print the table using knitr::kable()
knitr::kable(F_ROH_values_sorted, row.names = FALSE)

```

#3: Expected Heterozygosity

## 3.1 Empirical data

```{r Expected Heterozygosity - Empirical data}
setwd(Empirical_data_H_e_dir)
# # Set the working directory to the directory containing the H_e files for the empirical data
# setwd(Empirical_data_H_e_dir)
# 
# # List all PNG files in the directory
# # png_files <- list.files(pattern = "//.png$", full.names = TRUE)
# png_files <- list.files(pattern = "//.png$")
# 
# # Display each PNG file
# for (file in png_files) {
#   cat("File:", file, "/n")
#   # Open a PNG device
#   png::png(filename = file)
#   # Display image using readPNG() from the png package
#   raster <- png::readPNG(file)
#   graphics::plot.new()
#   graphics::plot.window(xlim = c(0, 1), ylim = c(0, 1), asp = 1)
#   graphics::rasterImage(raster, 0, 0, 1, 1)
#   # Close the PNG device
#   dev.off()
# }
# 
```

## 3.2 Neutral Model

```{r Expected Heterozygosity - Neutral Model }
# setwd(Neutral_model_H_e_dir)
# # Set the working directory to the directory containing the H_e files for the Neutral Model
# new_dir <- file.path(Neutral_model_H_e_dir,"test")
# #setwd(Neutral_model_H_e_dir)
# setwd(new_dir)
# # List all PNG files in the directory
# #png_files <- list.files(pattern = "//.png$", full.names = TRUE)
# png_files <- list.files(pattern = "//.png$")
# 
# library(png)
# 
# 
# # Display each PNG file
# for (file in png_files) {
#   file_path <- file.path(new_dir, file)
#   cat("File:", file, "/n")
#   # Display the image using include_graphics() from the knitr package
#   knitr::include_graphics(file_path)
# }
# 
# knitr::include_graphics("img",/rmarkdown_hex.png")


# # Display each PNG file
# for (file in png_files) {
#   cat("File:", file, "/n")
#   file_path <- file.path(Neutral_model_H_e_dir,file)
#   # Open a PNG device
#   png(filename = file_path)
#   # Display image using base R graphics functions
#   img <- readPNG(file)
#   graphics::plot.new()
#   graphics::plot.window(xlim = c(0, 1), ylim = c(0, 1), asp = 1)
#   graphics::rasterImage(img, 0, 0, 1, 1)
#   #Close the PNG device
#   dev.off()
# }


```
# 

# 4: Summary

## 4.0 General comparison
### 4.0.1 ROH-hotspot threshold comparison
```{r}

cat("\n ROH-hotspot threshold comparison between the different datasets")
# Print the table using knitr::kable()
knitr::kable(ROH_hotspot_threshold_values_sorted, row.names = FALSE)
```
### 4.0.1 F_ROH comparison
```{r}
 # Print the table using knitr::kable()
knitr::kable(F_ROH_values_sorted, row.names = FALSE)
```


## 4.1: Sweep test

```{r Sweep test}
setwd(Sweep_test_dir)
# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- "^.*neutral_model.*.tsv$"
selection_testing_files <- list.files(pattern = pattern)
# selection_testing_file

# Extracting the ROH-hotspot threshold value from the suffix of the filename
parts <- unlist(strsplit(selection_testing_file[1], "threshold_")) # Split the string by "threshold_"
# Extract the decimal number using regular expressions
fifth_percentile_H_e_neutral_model <- as.numeric(gsub("\\.tsv", "", unlist(strsplit(parts[length(parts)], "_"))[1]))

# Loop through each sorted .tsv file
for (file in sorted_population_ROH_freq_files) {

  file_name <- file


  # Read the header line
  con <- file(selection_testing_file, "r")
  header <- readLines(con, n = 1)
  close(con)

  # Remove "#" from the header and split it into column names
  column_names <- sub("#", "", header)
  column_names <- strsplit(column_names, "\t")[[1]]

  
  # # Read the .tsv frequency file into a data frame
  Selection_testing_results <- read.table(selection_testing_file, header = TRUE, comment.char = "#", stringsAsFactors = FALSE, col.names = column_names)

paste0("Selection test results")
paste0("ROH-hotspot windows with an mean H_e Value lower or equal to the fifth percentile of the neutral models average H_e are classified as being under selection")
paste0("5th percentile of the neutral model is: ",fifth_percentile_H_e_neutral_model)
Selection_testing_results
 
  

# Subset the dataframe to extract rows where Under_selection is "Yes"
under_selection_rows <- subset(Selection_testing_results, Under_selection == "Yes")
paste0("ROH-hotspots under selection:")
under_selection_rows
#view(Selection_testing_result)

```

## 4.2 : Selection Strength Test (H_e comparison)

```{r}
setwd(Selection_strength_test_dir)

# Pattern for finding files containing "F_ROH" and ending with ".tsv"
pattern <- "^.*selection_model.*.tsv$"
selection_strength_testing_files <- list.files(pattern = pattern)
# selection_testing_file


# Initialize an empty list to store Selection_Strength_test_results_tables
Selection_Strength_test_results_tables <- list()

# Loop through each selection coefficient and its associated file
for (i in seq_along(selection_strength_testing_files)) {
  # Extract the selection coefficient from the file name
  selection_coefficient <- sub(".*(selection_model_s\\d+_chr\\d+).*", "\\1", selection_strength_testing_files[i])
  
  # Read the .tsv file into a data frame
  subtable <- read.table(selection_strength_testing_files[i], header = TRUE, comment.char = "#", stringsAsFactors = FALSE)
  
  Selection_Strength_test_results_tables[[selection_coefficient]]$file_name <- selection_strength_testing_files[i]

  
  # Add the subtable to the list with the selection coefficient as its name
  Selection_Strength_test_results_tables[[selection_coefficient]]$results <- subtable
  
  
  
  # Extracting the ROH-hotspot threshold value from the suffix of the filename
    parts <- unlist(strsplit(selection_strength_testing_files[i], "threshold_")) # Split the string by "threshold_"
    # # Extract the decimal number using regular expressions
    fifth_percentile_H_e_selection_coefficient <- as.numeric(gsub("\\.tsv", "", unlist(strsplit(parts[length(parts)], "_"))[1]))
    Selection_Strength_test_results_tables[[selection_coefficient]]$fifth_percentile_H_e_threshold <- fifth_percentile_H_e_selection_coefficient
    
}

# # View the Selection_Strength_test_results_tables
# Selection_Strength_test_results_tables


# View the dataframe
View(Selection_Strength_test_results_tables)
#(Selection_Strength_test_df)



```
## 5.1 Visualizing Expected Heterozygoisty
```{r}
# Initialize an empty list to store the new table
hotspot_under_selection_H_e_table <- list()

# Loop through each row in under_selection_rows
for (i in 1:nrow(under_selection_rows)) {
  # Extract information for the current ROH-hotspot window
  current_window <- under_selection_rows[i, "Name"]
  under_selection <- under_selection_rows[i, "Under_selection"]
  Hotspot_Avg_H_e <- under_selection_rows[i, "Window_based_Average_H_e"]
  
  

  # Initialize a subtable for the current ROH-hotspot window
  subtable <- list()
  
  # Loop through each selection coefficient
  for (j in seq_along(Selection_Strength_test_results_tables)) {
    # Get the selection coefficient and its corresponding table
    selection_coefficient <- names(Selection_Strength_test_results_tables)[j]
    table <- Selection_Strength_test_results_tables[[j]]
    
    # Extract the filename and the fifth percentile H_e threshold
    filename <- table$file_name
    fifth_percentile_H_e_threshold <- table$fifth_percentile_H_e_threshold
    
    # Create a subtable for the current selection coefficient
    subtable[[selection_coefficient]] <- list(
      fifth_percentile_H_e_threshold = fifth_percentile_H_e_threshold,
      under_selection = under_selection
    )
  }
  
  # Add the subtable for the current ROH-hotspot window to the new table
  hotspot_under_selection_H_e_table[[current_window]] <- subtable
  hotspot_under_selection_H_e_table[[current_window]]$Hotspot_Avg_H_e <- Hotspot_Avg_H_e
}



# View the new table
View(hotspot_under_selection_H_e_table)
```

```{r}
# H_e_hotspot_visualization creates a visualization of the H_e distribution of the different selection coefficients, in comparison to each ROH-hotspot 
H_e_hotspot_visualization <- function(hotspot_name, hotspot_data) {

  # Extract the Hotspot_Avg_H_e value
  hotspot_avg_H_e <- hotspot_data$Hotspot_Avg_H_e
  
  # Extract selection coefficient names and fifth percentile H_e thresholds
  selection_coefficients <- names(hotspot_data)[-length(hotspot_data)]  # Exclude the Hotspot_Avg_H_e entry

  thresholds <- sapply(hotspot_data[-length(hotspot_data)], function(x) x$fifth_percentile_H_e_threshold)
  # print("thresholds")
  # print(thresholds)

  # Create a vector of names for the hotspot data
  hotspot_names <- rep(hotspot_name, length(hotspot_data) - 1)  # Exclude the Hotspot_Avg_H_e entry
  
  # Combine selection coefficients with "Hotspot"
  selection_coefficients <- paste0(selection_coefficients, "_Hotspot")

  # Create a vector for H_e combining thresholds and hotspot_avg_H_e
  H_e <- c(thresholds, hotspot_avg_H_e)

  # Create a vector for Type indicating "Selection Coefficient" for the selection coefficients and "Hotspot" for the last element
  Type <- c(rep("Selection Coefficient", length(selection_coefficients)), "Hotspot")

  # Create a dataframe
  df <- data.frame(
    Type = Type,
    H_e = H_e
  )
  
# df

# Extract labels for the different selection coefficients
selection_labels <- gsub(".*_(s\\d+)_.*", "\\1", selection_coefficients)


# Plot the visualization with labels for selection coefficients
p <- ggplot(df, aes(x = Type, y = H_e, color = Type)) +
  geom_point(size = 3) +
  geom_text(aes(label = ifelse(Type == "Hotspot", "", selection_labels)), position = position_jitter(width = 0.2), hjust = 3, vjust = -0.2, size = 3) +  # Add labels for selections
  labs(title = paste("Comparison of H_e Values for", hotspot_name),
       x = "Type",
       y = "H_e Value",
       color = "Type") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1.5))

return(p)



}

# Analyze and visualize each ROH hotspot independently
for (hotspot_name in names(hotspot_under_selection_H_e_table)) {
  cat("\nHotspot Name:",hotspot_name)

  hotspot_data <- hotspot_under_selection_H_e_table[[hotspot_name]]
  plot <- H_e_hotspot_visualization(hotspot_name, hotspot_data)
  print(plot)
}
# plot


``` 
